name: "Coverity tools for local analysis"
description: "Will add Coverity analysis tools into current runner PATH"
author: Jouni Lehto
branding:
  icon: shield
  color: blue
inputs:
  cov_version:
    description: "What version of Coverity Analysis is needed, example: cov-analysis-linux64-2022.6.1"
    default: cov-analysis-linux64-2022.6.1
    required: false
  cov_url:
    description: URL for Coverity Connect where the analysis tar file can be downloaded
    required: true
  cov_license:
    description: Path to the license file. License is needed for analysis. If license file is not given, then it will be downloaded from the Coverity Connect Downloads.
    required: false
  cov_install_folder:
    description: To which folder the tools are extracted
    required: true
  cov_remove_folders:
    description: With this you can space separated list of folders which you are not needed from Coverity Analysis and that way safe some space. (by default are removed architecture-analysis sdk dynamic-analysis forcheck doc)
    required: false
    default: architecture-analysis sdk dynamic-analysis forcheck doc
  cov_configures:
    description: With this you can configure Coverity Analysis. (by default cov-configure --java && cov-configure --javascript && cov-configure --python && cov-configure --kotlin && cov-configure --gcc --xml-option=prepend_arg:--ppp_translator --xml-option=prepend_arg:"replace/#\s*error \"Do not include _sd-common.h directly; it is a private header.\"/" && cov-configure --template --compiler c++ --comptype gcc && cov-configure --template --compiler cc --comptype gcc)
    required: false
    default: cov-configure --java && cov-configure --javascript && cov-configure --python && cov-configure --kotlin && cov-configure --gcc --xml-option=prepend_arg:--ppp_translator --xml-option=prepend_arg:"replace/#\s*error \"Do not include _sd-common.h directly; it is a private header.\"/" && cov-configure --template --compiler c++ --comptype gcc && cov-configure --template --compiler cc --comptype gcc

runs:
  using: composite
  steps:
    # First step is to download the Coverity Analysis tar -file and extract it and remove not needed folders to minimize the needed space.
    - run: |
        : #Get Coverity Analysis tools from Coverity server and extract them and remove tools which are not needed
        mkdir -p ${{inputs.cov_install_folder}}
        curl -f -o ${{inputs.cov_install_folder}}/${{inputs.cov_version}}.tar.gz ${{inputs.cov_url}}/downloads/${{inputs.cov_version}}.tar.gz
        cd ${{inputs.cov_install_folder}} && tar -xf ${{inputs.cov_version}}.tar.gz
        cd ${{inputs.cov_version}} && rm -rf ${{inputs.cov_remove_folders}}
        if [ -z ${{inputs.cov_license}} ]
        then 
          curl -f -o ${{inputs.cov_install_folder}}/${{inputs.cov_version}}/bin/license.dat ${{inputs.cov_url}}/downloads/license.dat
        else
          cp ${{inputs.cov_license}} ${{inputs.cov_install_folder}}/${{inputs.cov_version}}/bin
        fi
      shell: bash
    # Second step is to add coverity bin -folder into runners PATH
    - run: echo "${{inputs.cov_install_folder}}/${{inputs.cov_version}}/bin" >> $GITHUB_PATH
      shell: bash
    # Third step is to run Coverity configures.
    - run: |
        if [ ! -z ${{inputs.cov_configures}} ]
        then
          ${{inputs.cov_configures}}
        fi
      shell: bash
